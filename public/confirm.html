<!--confirm.html-->
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>R Studio ‚Äî Action Handler</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" href="./images/RSLogo.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Inter}
body{
  margin:0;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg,#6366f1,#7c3aed);
  padding:20px;
}

.card{
  width:100%;
  max-width:520px;
  padding:40px;
  border-radius:24px;
  background:white;
  box-shadow:0 30px 70px rgba(0,0,0,.25);
  animation:slideUp .4s ease;
}

@keyframes slideUp{
  from{opacity:0;transform:translateY(30px)}
  to{opacity:1;transform:translateY(0)}
}

.brand{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:14px;
  margin-bottom:32px;
}
.brand img{width:48px;height:48px}
.brand h1{margin:0;font-size:24px;font-weight:800;color:#111827}

.status-icon{
  font-size:72px;
  text-align:center;
  margin:24px 0;
  animation:bounce .6s ease;
}

@keyframes bounce{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-10px)}
}

.spinner{
  width:48px;
  height:48px;
  border:4px solid #e5e7eb;
  border-top-color:#6366f1;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:20px auto;
}

@keyframes spin{
  to{transform:rotate(360deg)}
}

h2{
  text-align:center;
  color:#111827;
  margin:20px 0 12px;
  font-size:26px;
  font-weight:800;
}

p{
  text-align:center;
  color:#6b7280;
  line-height:1.7;
  font-size:15px;
  margin:12px 0;
}

.info-box{
  background:#f3f4f6;
  border-radius:12px;
  padding:16px;
  margin:20px 0;
  text-align:left;
}
.info-box p{
  margin:8px 0;
  font-size:14px;
  color:#4b5563;
  text-align:left;
}
.info-box strong{color:#111827}

label{
  font-size:13px;
  font-weight:700;
  display:block;
  margin:16px 0 8px;
  color:#374151;
}

input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:2px solid #e5e7eb;
  font-size:14px;
  transition:border .2s;
}
input:focus{
  outline:none;
  border-color:#6366f1;
}

.button-group{
  display:flex;
  gap:12px;
  margin-top:32px;
  flex-wrap:wrap;
  justify-content:center;
}

button,a.button{
  padding:14px 28px;
  border-radius:12px;
  border:none;
  font-weight:700;
  font-size:15px;
  cursor:pointer;
  text-decoration:none;
  display:inline-block;
  transition:all .2s;
  text-align:center;
}

.btn-primary{
  background:linear-gradient(135deg,#6366f1,#7c3aed);
  color:white;
  box-shadow:0 4px 12px rgba(99,102,241,.3);
}
.btn-primary:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 16px rgba(99,102,241,.4);
}
.btn-primary:disabled{
  opacity:.6;
  cursor:not-allowed;
  transform:none;
}

.btn-secondary{
  background:#f3f4f6;
  color:#374151;
}
.btn-secondary:hover{
  background:#e5e7eb;
}

.success{color:#16a34a}
.error{color:#dc2626}
.loading{color:#6366f1}

.error-details{
  background:#fee2e2;
  border:2px solid #ef4444;
  border-radius:12px;
  padding:16px;
  margin:20px 0;
  text-align:left;
}

.error-details p{
  margin:8px 0;
  font-size:13px;
  color:#991b1b;
  text-align:left;
}

.error-details strong{
  color:#7f1d1d;
}

@media (max-width:600px){
  .card{padding:28px 24px}
  h2{font-size:22px}
  .button-group{flex-direction:column}
  button,a.button{width:100%}
}
</style>
</head>

<body>

<div class="card">
  <div class="brand">
    <img src="./images/RSLogo.png" alt="R Studio">
    <h1>R STUDIO</h1>
  </div>

  <div id="content">
    <div class="spinner"></div>
    <h2>Memproses...</h2>
    <p>Mohon tunggu sebentar</p>
  </div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import {
  applyActionCode,
  verifyPasswordResetCode,
  confirmPasswordReset,
  signInAnonymously
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

import {
  doc,
  updateDoc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const content = document.getElementById("content");
const params = new URLSearchParams(window.location.search);

const mode = params.get("mode");
const oobCode = params.get("oobCode");

if (!mode || !oobCode) {
  showError("Link Tidak Valid", "Link rusak atau tidak lengkap.");
} else {
  router(mode, oobCode);
}

/* ================= ROUTER ================= */
async function router(mode, code) {
  switch (mode) {
    case "verifyEmail":
      await verifyEmail(code);
      break;

    case "resetPassword":
      await resetPassword(code);
      break;

    default:
      showError("Mode Tidak Dikenal", "Action tidak valid.");
  }
}

/* ================= VERIFY EMAIL ================= */
async function verifyEmail(code) {
  try {
    // 1. ‚úÖ Apply verification code DULU (ini tidak perlu auth)
    await applyActionCode(auth, code);
    
    console.log("‚úÖ Email verification code applied");

    // 2. ‚úÖ Cek apakah user sedang login
    let currentUser = auth.currentUser;
    
    if (currentUser) {
      console.log("User sudah login, update Firestore...");
      
      // Reload untuk update status
      await currentUser.reload();
      
      // Update Firestore
      try {
        await updateDoc(doc(db, "users", currentUser.uid), {
          emailVerified: true,
          emailVerifiedAt: Date.now()
        });
        console.log("‚úÖ Firestore updated");
      } catch (firestoreErr) {
        console.warn("‚ö†Ô∏è Firestore update failed:", firestoreErr.message);
        // Tidak masalah, yang penting Auth sudah verified
      }
    } else {
      console.log("User belum login, skip Firestore update");
      // Firestore akan diupdate saat user login di profile.html
    }

    showSuccess(
      "Email Terverifikasi!",
      "Email kamu berhasil diverifikasi. Login untuk melihat perubahan."
    );
    
  } catch (err) {
    console.error("Verifikasi error:", err);
    
    // Better error handling
    let errorTitle = "Verifikasi Gagal";
    let errorMessage = "";
    let errorDetails = [];
    
    if (err.code === "auth/expired-action-code") {
      errorTitle = "Link Expired";
      errorMessage = "Link verifikasi sudah kadaluarsa.";
      errorDetails = [
        "‚è∞ Link hanya berlaku selama beberapa jam",
        "üîÑ Kembali ke profile dan klik 'Verifikasi Email' lagi",
        "üìß Link baru akan dikirim ke email kamu"
      ];
    } else if (err.code === "auth/invalid-action-code") {
      errorTitle = "Link Tidak Valid";
      errorMessage = "Link sudah digunakan atau tidak valid.";
      errorDetails = [
        "‚úÖ Email mungkin sudah terverifikasi sebelumnya",
        "üîë Atau link sudah pernah digunakan",
        "üîÑ Coba login untuk cek status verifikasi"
      ];
    } else {
      errorMessage = "Terjadi kesalahan saat memverifikasi email.";
      errorDetails = [
        "‚ùå Error: " + (err.message || "Unknown error"),
        "üîÑ Coba minta link verifikasi baru",
        "üí¨ Atau hubungi admin jika masalah berlanjut"
      ];
    }
    
    showErrorWithDetails(errorTitle, errorMessage, errorDetails);
  }
}

/* ================= RESET PASSWORD ================= */
async function resetPassword(code) {
  try {
    await verifyPasswordResetCode(auth, code);

    content.innerHTML = `
      <div class="status-icon">üîê</div>
      <h2>Reset Password</h2>
      <p>Masukkan password baru kamu</p>
      
      <label>Password Baru</label>
      <input id="newPass" type="password" placeholder="Minimal 6 karakter">
      
      <label>Konfirmasi Password</label>
      <input id="confirmPass" type="password" placeholder="Ketik ulang password">
      
      <div class="button-group">
        <button class="btn-primary" id="submitBtn">üíæ Simpan Password</button>
      </div>
    `;

    document.getElementById("submitBtn").onclick = async () => {
      const p1 = document.getElementById("newPass").value;
      const p2 = document.getElementById("confirmPass").value;

      if (!p1 || !p2) {
        alert("‚ö†Ô∏è Semua field harus diisi");
        return;
      }

      if (p1 !== p2) {
        alert("‚ùå Password tidak cocok");
        return;
      }

      if (p1.length < 6) {
        alert("‚ùå Password minimal 6 karakter");
        return;
      }

      try {
        document.getElementById("submitBtn").disabled = true;
        document.getElementById("submitBtn").textContent = "Menyimpan...";

        await confirmPasswordReset(auth, code, p1);
        
        showSuccess(
          "Password Berhasil Diubah!",
          "Password kamu telah diperbarui. Silakan login dengan password baru."
        );
      } catch (err) {
        alert("‚ùå Gagal mengubah password: " + err.message);
        document.getElementById("submitBtn").disabled = false;
        document.getElementById("submitBtn").textContent = "üíæ Simpan Password";
      }
    };
  } catch (err) {
    console.error("Reset password error:", err);
    
    let errorTitle = "Reset Password Gagal";
    let errorMessage = "";
    let errorDetails = [];
    
    if (err.code === "auth/expired-action-code") {
      errorTitle = "Link Expired";
      errorMessage = "Link reset password sudah kadaluarsa.";
      errorDetails = [
        "‚è∞ Link hanya berlaku selama 1 jam",
        "üîÑ Kembali ke halaman login",
        "üîë Klik 'Lupa Password' untuk mendapat link baru"
      ];
    } else if (err.code === "auth/invalid-action-code") {
      errorTitle = "Link Tidak Valid";
      errorMessage = "Link reset sudah digunakan atau tidak valid.";
      errorDetails = [
        "‚úÖ Password mungkin sudah direset sebelumnya",
        "üîë Atau link sudah pernah digunakan",
        "üîÑ Minta link reset baru dari halaman login"
      ];
    } else {
      errorMessage = "Terjadi kesalahan saat reset password.";
      errorDetails = [
        "‚ùå Error: " + (err.message || "Unknown error"),
        "üîÑ Coba minta link reset baru",
        "üí¨ Atau hubungi admin jika masalah berlanjut"
      ];
    }
    
    showErrorWithDetails(errorTitle, errorMessage, errorDetails);
  }
}

/* ================= UI HELPERS ================= */
function showSuccess(title, msg) {
  content.innerHTML = `
    <div class="status-icon">‚úÖ</div>
    <h2 class="success">${title}</h2>
    <p>${msg}</p>
    <div class="info-box">
      <p><strong>‚ú® Langkah selanjutnya:</strong></p>
      <p>‚Ä¢ Login ke akun kamu</p>
      <p>‚Ä¢ Status verifikasi akan otomatis terupdate</p>
      <p>‚Ä¢ Nikmati akses penuh ke semua fitur</p>
    </div>
    <div class="button-group">
      <a href="login.html" class="btn-primary">üöÄ Login Sekarang</a>
      <a href="profile.html" class="btn-secondary">üì± Ke Profile</a>
    </div>
  `;
}

function showError(title, msg) {
  content.innerHTML = `
    <div class="status-icon">‚ùå</div>
    <h2 class="error">${title}</h2>
    <p>${msg}</p>
    <div class="button-group">
      <a href="login.html" class="btn-secondary">‚Üê Kembali ke Login</a>
    </div>
  `;
}

function showErrorWithDetails(title, msg, details) {
  const detailsHTML = details.map(d => `<p>‚Ä¢ ${d}</p>`).join("");
  
  content.innerHTML = `
    <div class="status-icon">‚ùå</div>
    <h2 class="error">${title}</h2>
    <p>${msg}</p>
    
    <div class="error-details">
      <strong>Kemungkinan penyebab:</strong>
      ${detailsHTML}
    </div>
    
    <div class="button-group">
      <a href="profile.html" class="btn-primary">üîÑ Coba Lagi</a>
      <a href="login.html" class="btn-secondary">‚Üê Login</a>
    </div>
  `;
}
</script>

</body>
</html>