<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="home.css">
<link rel="icon" type="image/png" href="./images/RSLogo.png">
<link rel="icon" type="image/png" sizes="32x32" href="./images/RSLogo.png">
<link rel="apple-touch-icon" href="./images/RSLogo.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

</head>

<body>

<div class="loading-screen" id="loadingScreen">
  <!-- Floating Cubes -->
  <div class="load-cube"></div>
  <div class="load-cube"></div>
  <div class="load-cube"></div>
  <div class="load-cube"></div>
  
  <!-- Particles -->
  <div class="load-particles">
    <div class="load-particle"></div>
    <div class="load-particle"></div>
    <div class="load-particle"></div>
    <div class="load-particle"></div>
    <div class="load-particle"></div>
    <div class="load-particle"></div>
    <div class="load-particle"></div>
    <div class="load-particle"></div>
    <div class="load-particle"></div>
    <div class="load-particle"></div>
  </div>
  
  <!-- Main Content -->
  <div class="load-content">
    <!-- Logo Spinner -->
    <div class="load-spinner">
      <div class="spin-ring"></div>
      <div class="spin-ring"></div>
      <div class="spin-ring"></div>
      
      <div class="orbit-dots">
        <div class="orbit-dot"></div>
        <div class="orbit-dot"></div>
        <div class="orbit-dot"></div>
      </div>
      
      <div class="load-logo">
        <img src="./images/RSLogo.png" alt="RS Logo" style="width: 70px; height: 70px; object-fit: contain; position: relative; z-index: 1; filter: drop-shadow(0 4px 12px rgba(255,255,255,0.6));">
      </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="load-progress">
      <div class="progress-track">
        <div class="progress-bar-fill" id="progressBarFill"></div>
      </div>
      <div class="progress-percent" id="progressPercent">0%</div>
    </div>
    
    <!-- Title -->
    <div class="load-title">
      <span class="load-letter">R</span>
      <span class="load-letter">S</span>
      <span class="load-letter">T</span>
      <span class="load-letter">U</span>
      <span class="load-letter">D</span>
      <span class="load-letter">I</span>
      <span class="load-letter">O</span>
    </div>
    
    <div class="load-subtitle">Learn Roblox Studio Development</div>
  </div>
</div>


<!-- NAVBAR -->
<div class="navbar">
  <div class="brand">
    <h2>R STUDIO</h2>
    <span>Learn Roblox Studio Development</span>
  </div>

  <div style="display:flex;align-items:center;gap:16px">

    <!-- BERLANGGANAN -->
    <a href="subscribe.html" class="subscribe-btn">
      üíé Berlangganan
    </a>

    <!-- PROFILE -->
    <div class="profile">
      <div class="avatar" id="avatar">
        <img id="avatarImg" style="display:none">
        <span id="avatarText">R</span>
      </div>

      <div class="dropdown" id="dropdown">
        <a href="profile.html">üë§ Profile</a>
        <a href="license.html">üîê License</a>
        <a href="admin.html" id="adminMenu" style="display:none">üõ† Admin Panel</a>
        <a href="login.html" id="logoutBtn">üö™ Logout</a>
      </div>
    </div>

  </div>
</div>

<!-- CONTENT -->
<div class="container">

  <div class="hero">
    <h1>Welcome to R STUDIO üöÄ</h1>
    <p>Creative dashboard for Roblox developers & creators</p>
    <div class="status" id="roleBadge">üë§ Member</div>
  </div>

  <div class="section" id="content">
    <h3>üé¨ Video Library</h3>
    <p>Tutorial & konten eksklusif R Studio</p>

    <div class="grid">

      <div class="card">
        <div class="thumb">
          <img
            src="./images/comingsoon.avif"
            alt="Coming Soon"
          />
        </div>

        <h4>???</h4>
        <div class="badge">VIP MODEL</div>
        <button
          type="button"
          class="download vip-download"
          data-file="???">
          ‚¨á Download File ‚¨á
        </button>
      </div>

      <div class="card">
        <div class="thumb">
          <img
            src="./images/carrythumb.png"
            alt="Carry System 2 Pilihan V1"
          />
        </div>

        <h4>Carry System 2 Pilihan V1</h4>
        <div class="badge">FREE MODEL</div>
        <a class="download" href="https://create.roblox.com/store/asset/89467272654433" target="_blank">
          ‚¨á Download File ‚¨á
        </a>
      </div>

      <div class="card">
          <iframe 
            src="https://www.youtube.com/embed/pcWO2OjrPMk"
            title="Confession Wall System"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
          </iframe>

        <h4>Confession Wall System V1</h4>
        <div class="badge">FREE MODEL</div>
        <a class="download" href="https://create.roblox.com/store/asset/109183734627151" target="_blank">
          ‚¨á Download File ‚¨á
        </a>
      </div>

      <div class="card">
          <iframe 
            src="https://www.youtube.com/embed/Tnn-pOS2-vo"
            title="Summit Kit V1"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
          </iframe>

        <h4>Summit Kit V1</h4>
        <div class="badge">FREE MODEL</div>
        <a class="download" href="https://create.roblox.com/store/asset/135286176326484" target="_blank">
          ‚¨á Download File ‚¨á
        </a>
      </div>

    </div>
  </div>

</div>
<!-- Modern Footer -->
<footer class="footer">
    <div class="footer-content">
        <!-- About Section -->
        <div class="footer-section">
            <h3>R STUDIO</h3>
            <p>Building the future of Roblox development with cutting-edge tools and solutions. Join thousands of developers creating amazing experiences.</p>
            <div class="social-links">
                <a href="https://www.roblox.com/communities/13174452/R-TEAMX#!/about" class="social-link" title="Roblox">
                  <img src="./images/roblox-icon.png" alt="Roblox" style="width: 24px; height: 24px; position: relative; z-index: 1;">
                </a>
                <a href="https://discord.gg/AUAzsxPP27" class="social-link" title="Discord">
                    <img src="./images/discord-icon.jpg" alt="Discord" style="width: 24px; height: 24px; position: relative; z-index: 1;">
                </a>
                <a href="https://www.youtube.com/@ahmadrodiii" class="social-link" title="YouTube">
                    <img src="./images/youtube-icon.png" alt="YouTube" style="width: 24px; height: 24px; position: relative; z-index: 1;">
                </a>
                <a href="https://www.instagram.com/ahmadrodiii" class="social-link" title="Instagram">
                    <img src="./images/instagram-icon.png" alt="Instagram" style="width: 24px; height: 24px; position: relative; z-index: 1;">
                </a>
            </div>
        </div>

        <!-- Resources -->
        <div class="footer-section">
            <h3>Resources</h3>
            <div class="footer-links">
                <a href="#content">Tutorials</a>
                <a href="license.html">License</a>
                <a href="https://discord.gg/AUAzsxPP27">Community</a>
                <a href="subscribe.html">Support</a>
            </div>
        </div>

        <!-- Newsletter -->
        <div class="footer-section">
            <h3>Stay Updated</h3>
            <p>Get the latest updates and news delivered to your inbox.</p>
            <form class="newsletter-form" onsubmit="return false;">
                <input type="email" class="newsletter-input" placeholder="Enter your email" required>
                <button type="submit" class="newsletter-btn">Subscribe</button>
            </form>
        </div>
    </div>

    <div class="footer-bottom">
        <p>&copy; 2025 R STUDIO. All rights reserved.</p>
        <div class="footer-bottom-links">
            <a href="#privacy">Privacy Policy</a>
            <a href="#terms">Terms of Service</a>
            <a href="#cookies">Cookies</a>
        </div>
    </div>
</footer>

<script type="module">
import { auth, db, checkMaintenance } from "./firebase.js";
import { onAuthStateChanged, getAuth, signOut } from
  "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { doc, getDoc } from
  "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

// LOADING SCREEN HANDLER
let progress = 0;
const fill = document.getElementById('progressBarFill');
const text = document.getElementById('progressPercent');

const interval = setInterval(() => {
  if (progress < 100) {
    progress += Math.random() * 4 + 2;
    if (progress > 100) progress = 100;
    
    if (fill && text) {
      fill.style.width = progress + '%';
      text.textContent = Math.floor(progress) + '%';
    }
  } else {
    clearInterval(interval);
    // Hide after complete
    setTimeout(() => {
      document.getElementById('loadingScreen').classList.add('hidden');
    }, 500);
  }
}, 200);

const avatar = document.getElementById("avatar");
const avatarImg = document.getElementById("avatarImg");
const avatarText = document.getElementById("avatarText");
const dropdown = document.getElementById("dropdown");
const adminMenu = document.getElementById("adminMenu");
const roleBadge = document.getElementById("roleBadge");
const subscribeBtn = document.querySelector(".subscribe-btn");
const vipButtons = document.querySelectorAll(".vip-download");

let HAS_VIP_ACCESS = false;

vipButtons.forEach(btn => {
  btn.onclick = async () => {

    // ‚õî STOP SEBELUM FETCH
    if (!HAS_VIP_ACCESS) {
      alert("üíé Konten VIP ‚Äî Silakan berlangganan dulu");
      return;
    }

    try {
      const user = getAuth().currentUser;
      
      const token = await user.getIdToken();

      const res = await fetch("/api/download", {
        headers: {
          Authorization: "Bearer " + token
        }
      });

      if (!res.ok) {
        alert("Gagal download");
        return;
      }

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "???";
      a.click();

      URL.revokeObjectURL(url);

    } catch (e) {
      alert("Server error");
    }
  };
});


avatar.onclick = () => {
  dropdown.style.display =
    dropdown.style.display === "block" ? "none" : "block";
};

// DEFAULT (SEBELUM AUTH)
subscribeBtn.style.display = "inline-flex";

onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";

  await checkMaintenance();
  
  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists()) return;

  const data = snap.data();
  const role = data.role || "member";
  const isVIP = data.isVIP === true;

  const hasVIPAccess =
    isVIP || role === "admin" || role === "owner";
  
  HAS_VIP_ACCESS = hasVIPAccess;

  // BADGE
  roleBadge.textContent =
    role === "owner" ? "üëë Owner" :
    role === "admin" ? "üõ† Admin" :
    hasVIPAccess ? "üíé VIP" :
    "üë§ Member";

  // ADMIN MENU
  adminMenu.style.display =
    role === "admin" || role === "owner"
      ? "block"
      : "none";

  // ===== AVATAR SYNC =====
  if (data.photoBase64) {
    avatarImg.src = data.photoBase64;
    avatarImg.style.display = "block";
    avatarText.style.display = "none";
  } else {
    avatarText.textContent =
      (user.displayName || user.email)[0].toUpperCase();
    avatarImg.style.display = "none";
    avatarText.style.display = "block";
  }

  // SUBSCRIBE BUTTON RULE
  let showSubscribe = true;

  if (isVIP) showSubscribe = false;
  if (role === "admin" && isVIP) showSubscribe = false;
  if (role === "owner") showSubscribe = true;

  subscribeBtn.style.display =
    showSubscribe ? "inline-flex" : "none";

  });


document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
  location.href = "login.html";
};
</script>



</body>
</html>
