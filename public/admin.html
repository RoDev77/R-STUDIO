<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Panel â€” R Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" href="./images/RSLogo.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:#f8fafc;
  color:#111827;
}

/* ===== NAVBAR ===== */
.navbar{
  height:64px;
  padding:0 28px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:linear-gradient(135deg,#6366f1,#7c5cf4);
  color:white;
}
.brand h2{margin:0;font-size:20px;font-weight:800}
.brand span{font-size:12px;opacity:.85}

/* ===== AVATAR ===== */
.profile{
  position:relative;
}
.avatar{
  width:42px;
  height:42px;
  border-radius:50%;
  background:white;
  color:#6d7cf2;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  cursor:pointer;
}
.avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:50%;
}

/* dropdown */
.dropdown{
  position:absolute;
  right:0;
  top:52px;
  width:180px;
  background:white;
  border-radius:14px;
  box-shadow:0 25px 50px rgba(0,0,0,.15);
  overflow:hidden;
  display:none;
}

.dropdown a{
  display:block;
  padding:14px 16px;
  font-size:14px;
  text-decoration:none;
  color:#111827;
}
.dropdown a:hover{
  background:#f3f4f6;
}

/* ===== CONTAINER ===== */
.container{
  max-width:1200px;
  margin:auto;
  padding:28px;
}

/* ===== TABS ===== */
.tabs{
  display:flex;gap:10px;flex-wrap:wrap;
  margin-bottom:20px;
}
.tab{
  padding:10px 16px;
  border-radius:999px;
  background:#e5e7eb;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
}
.tab.active{
  background:#6366f1;
  color:white;
}

/* ===== CARD ===== */
.card{
  background:white;
  border-radius:20px;
  padding:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.05);
  margin-bottom:24px;
}

/* ===== TABLE ===== */
table{width:100%;border-collapse:separate;border-spacing:0 10px}
thead th{
  font-size:12px;text-transform:uppercase;
  color:#6b7280;text-align:left;padding:10px;
}
tbody tr{background:#f9fafb}
tbody tr:hover{background:#eef2ff}
td{padding:14px}

/* ===== USER CELL ===== */
.user{
  display:flex;align-items:center;gap:12px;
}
.user img{
  width:38px;height:38px;border-radius:50%;
}
.user small{display:block;color:#6b7280;font-size:12px}

/* ===== BADGE ===== */
.badge{
  padding:6px 12px;border-radius:999px;
  font-size:12px;font-weight:700;
}
.vip{background:#dcfce7;color:#166534}
.free{background:#e5e7eb;color:#374151}
.admin{background:#fef3c7;color:#92400e}
.owner{background:#fde68a;color:#92400e}

/* ===== BUTTON ===== */
button{
  padding:8px 14px;border-radius:12px;
  border:none;font-size:12px;
  font-weight:700;cursor:pointer;
}
.primary{background:#6366f1;color:white}
.danger{background:#ef4444;color:white}
.gray{background:#e5e7eb}

/* ===== INPUT ===== */
input{
  padding:12px 14px;border-radius:12px;
  border:1px solid #e5e7eb;font-size:14px;
}
input:focus{outline:none;border-color:#6366f1}

/* ===== HIDDEN ===== */
.hidden{display:none}
.center{text-align:center;color:#6b7280}
</style>
</head>

<body>

<div class="navbar">
  <div class="brand">
    <h2>R STUDIO</h2>
    <span>Admin Panel</span>
  </div>
<!-- PROFILE -->
    <div class="profile">
      <div class="avatar" id="avatar">
        <img id="avatarImg" style="display:none">
        <span id="avatarText">R</span>
      </div>

      <div class="dropdown" id="dropdown">
        <a href="https://rstudiolab.online/">ðŸš€ Home</a>
        <a href="profile.html">ðŸ‘¤ Profile</a>
        <a href="login.html" id="logoutBtn">ðŸšª Logout</a>
      </div>
    </div>
</div>

<div class="container">

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" data-tab="users">ðŸ‘¥ Users</div>
    <div class="tab" data-tab="vip">ðŸ’Ž VIP Requests</div>
    <div class="tab" data-tab="system">ðŸ›  System</div>
    <div class="tab" data-tab="logs">ðŸ§¾ Logs</div>
  </div>

  <!-- USERS -->
  <div id="users" class="card">
    <input id="searchUser" placeholder="Cari nama atau email..." style="width:100%;margin-bottom:16px">
    <table>
      <thead>
        <tr>
          <th>User</th>
          <th>Role</th>
          <th>VIP</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="userList"></tbody>
    </table>
    <p id="userEmpty" class="center hidden">Tidak ada user</p>
  </div>

  <!-- VIP REQUESTS -->
  <div id="vip" class="card hidden">
    <table>
      <thead>
        <tr>
          <th>User</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="vipList"></tbody>
    </table>
    <p id="vipEmpty" class="center hidden">Tidak ada request</p>
  </div>

  <!-- SYSTEM -->
  <div id="system" class="card hidden">
    <h3>Maintenance Mode</h3>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="primary" id="mtOn">Aktifkan</button>
      <button class="danger" id="mtOff">Matikan</button>
    </div>
    <p id="mtStatus" style="margin-top:12px"></p>
  </div>

  <!-- LOGS -->
  <div id="logs" class="card hidden">
    <table>
      <thead>
        <tr>
          <th>Action</th>
          <th>Target</th>
          <th>Admin</th>
        </tr>
      </thead>
      <tbody id="logList"></tbody>
    </table>
  </div>

</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, getAuth, signOut } from
"https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import {
  collection, getDocs, getDoc, doc,
  updateDoc, addDoc, serverTimestamp
} from
"https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
  
const avatar = document.getElementById("avatar");
const avatarImg = document.getElementById("avatarImg");
const avatarText = document.getElementById("avatarText");
const dropdown = document.getElementById("dropdown");

avatar.onclick = () => {
  dropdown.style.display =
    dropdown.style.display === "block" ? "none" : "block";
};

/* ===== TABS ===== */
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
    t.classList.add("active");
    document.getElementById(t.dataset.tab).classList.remove("hidden");
  }
});

/* ===== AUTH ===== */
onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";

  const snap = await getDoc(doc(db,"users",user.uid));
  if (!snap.exists()) return location.href = "/";

  const data = snap.data(); // âœ… FIX UTAMA DI SINI

  if (!["admin","owner"].includes(data.role))
    return location.href = "/";

  /* ===== AVATAR SYNC ===== */
  if (data.photoBase64) {
    avatarImg.src = data.photoBase64;
    avatarImg.style.display = "block";
    avatarText.style.display = "none";
  } else {
    avatarText.textContent =
      (data.name || user.email)[0].toUpperCase();
    avatarImg.style.display = "none";
    avatarText.style.display = "block";
  }

  loadUsers();
  loadVip();
  loadMaintenance();
  loadLogs();
});


document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
  location.href = "login.html";
};

/* ===== USERS ===== */
const userList = document.getElementById("userList");
const searchUser = document.getElementById("searchUser");
let users=[];

async function loadUsers(){
  const snap = await getDocs(collection(db,"users"));
  users = snap.docs.map(d=>({uid:d.id,...d.data()}));
  renderUsers();
}

searchUser.oninput = renderUsers;

function renderUsers(){
  userList.innerHTML="";
  const q = searchUser.value.toLowerCase();
  const filtered = users.filter(u =>
    !q || u.name?.toLowerCase().includes(q) || u.email.toLowerCase().includes(q)
  );

  document.getElementById("userEmpty").classList.toggle("hidden", filtered.length);

  filtered.forEach(u=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="user">
        <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
        <div>
          <strong>${u.name || "-"}</strong>
          <small>${u.email}</small>
        </div>
      </td>
      <td><span class="badge ${u.role}">${u.role}</span></td>
      <td><span class="badge ${u.isVIP?"vip":"free"}">${u.isVIP?"VIP":"FREE"}</span></td>
      <td>
        ${u.role==="member"
          ? `<button class="primary">Toggle VIP</button>`
          : "â€”"}
      </td>
    `;
    const btn=tr.querySelector("button");
    if(btn) btn.onclick=()=>toggleVIP(u);
    userList.appendChild(tr);
  });
}

async function toggleVIP(u){
  if(!confirm("Ubah status VIP user ini?")) return;
  await updateDoc(doc(db,"users",u.uid),{isVIP:!u.isVIP});
  await log("TOGGLE_VIP",u.uid);
  loadUsers();
}

/* ===== VIP REQUESTS ===== */
async function loadVip(){
  const snap = await getDocs(collection(db,"vip_requests"));
  const list = snap.docs.map(d=>({id:d.id,...d.data()}));
  const tbody=document.getElementById("vipList");
  tbody.innerHTML="";
  document.getElementById("vipEmpty").classList.toggle("hidden", list.length);

  list.forEach(v=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${v.email}</td>
      <td>${v.status}</td>
      <td>
        ${v.status==="pending"
          ? `<button class="primary">Approve</button>`
          : "â€”"}
      </td>
    `;
    const btn=tr.querySelector("button");
    if(btn) btn.onclick=()=>approveVIP(v);
    tbody.appendChild(tr);
  });
}

async function approveVIP(v){
  await updateDoc(doc(db,"vip_requests",v.id),{
    status:"approved",approvedAt:serverTimestamp()
  });
  await updateDoc(doc(db,"users",v.uid),{isVIP:true});
  await log("APPROVE_VIP",v.uid);
  loadVip();loadUsers();
}

/* ===== MAINTENANCE ===== */
const mtRef=doc(db,"settings","maintenance");
async function loadMaintenance(){
  const snap=await getDoc(mtRef);
  document.getElementById("mtStatus").textContent =
    snap.exists() && snap.data().enabled
      ? "ðŸŸ¢ Maintenance AKTIF"
      : "âšª Maintenance NONAKTIF";
}
document.getElementById("mtOn").onclick=()=>updateDoc(mtRef,{enabled:true});
document.getElementById("mtOff").onclick=()=>updateDoc(mtRef,{enabled:false});

/* ===== LOGS ===== */
async function loadLogs(){
  const snap = await getDocs(collection(db,"admin_logs"));
  const tbody=document.getElementById("logList");
  tbody.innerHTML="";
  snap.docs.slice(0,50).forEach(l=>{
    const d=l.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${d.action}</td>
      <td>${d.targetUid}</td>
      <td>${d.adminEmail}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function log(action,targetUid){
  await addDoc(collection(db,"admin_logs"),{
    action,targetUid,
    adminUid:auth.currentUser.uid,
    adminEmail:auth.currentUser.email,
    timestamp:serverTimestamp()
  });
}
</script>

</body>
</html>
