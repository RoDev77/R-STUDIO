<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Panel ‚Äî R Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" href="./images/RSLogo.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:#f8fafc;
  color:#111827;
}

/* ===== NAVBAR ===== */
.navbar{
  height:64px;
  padding:0 28px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:linear-gradient(135deg,#6366f1,#7c5cf4);
  color:white;
}
.brand h2{margin:0;font-size:20px;font-weight:800}
.brand span{font-size:12px;opacity:.85}

/* ===== AVATAR ===== */
.profile{
  position:relative;
}
.avatar{
  width:42px;
  height:42px;
  border-radius:50%;
  background:white;
  color:#6d7cf2;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  cursor:pointer;
}
.avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:50%;
}

/* dropdown */
.dropdown{
  position:absolute;
  right:0;
  top:52px;
  width:180px;
  background:white;
  border-radius:14px;
  box-shadow:0 25px 50px rgba(0,0,0,.15);
  overflow:hidden;
  display:none;
  z-index:99;
}

.dropdown a{
  display:block;
  padding:14px 16px;
  font-size:14px;
  text-decoration:none;
  color:#111827;
}
.dropdown a:hover{
  background:#f3f4f6;
}

/* ===== CONTAINER ===== */
.container{
  max-width:1200px;
  margin:auto;
  padding:28px;
}

/* ===== TABS ===== */
.tabs{
  display:flex;gap:10px;flex-wrap:wrap;
  margin-bottom:20px;
}
.tab{
  padding:10px 16px;
  border-radius:999px;
  background:#e5e7eb;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  transition:all .2s;
}
.tab:hover{
  background:#d1d5db;
}
.tab.active{
  background:#6366f1;
  color:white;
}

/* ===== CARD ===== */
.card{
  background:white;
  border-radius:20px;
  padding:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.05);
  margin-bottom:24px;
}

/* ===== TABLE ===== */
table{width:100%;border-collapse:separate;border-spacing:0 10px}
thead th{
  font-size:12px;text-transform:uppercase;
  color:#6b7280;text-align:left;padding:10px;
}
tbody tr{background:#f9fafb;transition:all .2s}
tbody tr:hover{background:#eef2ff}
td{padding:14px}

/* ===== USER CELL ===== */
.user{
  display:flex;align-items:center;gap:12px;
}
.user img{
  width:38px;height:38px;border-radius:50%;
}
.user small{display:block;color:#6b7280;font-size:12px}

/* ===== BADGE ===== */
.badge{
  padding:6px 12px;border-radius:999px;
  font-size:12px;font-weight:700;
}
.vip{background:#dcfce7;color:#166534}
.free{background:#e5e7eb;color:#374151}
.admin{background:#fef3c7;color:#92400e}
.owner{background:#fde68a;color:#92400e}
.member{background:#e5e7eb;color:#374151}

/* ===== BUTTON ===== */
button{
  padding:8px 14px;border-radius:12px;
  border:none;font-size:12px;
  font-weight:700;cursor:pointer;
  transition:all .2s;
}
button:hover{
  opacity:0.8;
}
button:disabled{
  opacity:0.5;
  cursor:not-allowed;
}
.primary{background:#6366f1;color:white}
.danger{background:#ef4444;color:white}
.success{background:#10b981;color:white}
.gray{background:#e5e7eb}

/* ===== INPUT ===== */
input{
  padding:12px 14px;border-radius:12px;
  border:1px solid #e5e7eb;font-size:14px;
}
input:focus{outline:none;border-color:#6366f1}

/* ===== HIDDEN ===== */
.hidden{display:none}
.center{text-align:center;color:#6b7280;padding:20px}
</style>
</head>

<body>

<div class="navbar">
  <div class="brand">
    <h2>R STUDIO</h2>
    <span>Admin Panel</span>
  </div>

  <!-- PROFILE -->
  <div class="profile">
    <div class="avatar" id="avatar">
      <img id="avatarImg" style="display:none">
      <span id="avatarText">R</span>
    </div>

    <div class="dropdown" id="dropdown">
      <a href="https://rstudiolab.online/">üöÄ Home</a>
      <a href="license.html">üîê License</a>
      <a href="profile.html">üë§ Profile</a>
      <a href="#" id="logoutBtn">üö™ Logout</a>
    </div>
  </div>
</div>

<div class="container">

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" data-tab="users">üë• Users</div>
    <div class="tab" data-tab="vip">üíé VIP Requests</div>
    <div class="tab" data-tab="system">üõ† System</div>
    <div class="tab" data-tab="logs">üßæ Logs</div>
  </div>

  <!-- USERS -->
  <div id="users" class="card">
    <input id="searchUser" placeholder="Cari nama atau email..." style="width:100%;margin-bottom:16px">
    <table>
      <thead>
        <tr>
          <th>User</th>
          <th>Role</th>
          <th>VIP</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="userList"></tbody>
    </table>
    <p id="userEmpty" class="center hidden">Tidak ada user</p>
  </div>

  <!-- VIP REQUESTS -->
  <div id="vip" class="card hidden">
    <table>
      <thead>
        <tr>
          <th>User</th>
          <th>Total</th>
          <th>ID Transaksi</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="vipList"></tbody>
    </table>
    <p id="vipEmpty" class="center hidden">Tidak ada request VIP</p>
  </div>

  <!-- SYSTEM -->
  <div id="system" class="card hidden">
    <h3>‚öôÔ∏è Maintenance Mode</h3>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="danger" id="mtOn">üî¥ Aktifkan</button>
      <button class="success" id="mtOff">üü¢ Matikan</button>
    </div>
    <p id="mtStatus" style="margin-top:12px;font-weight:600"></p>
  </div>

  <!-- LOGS -->
  <div id="logs" class="card hidden">
    <h3>üìã Activity Logs</h3>
    <table>
      <thead>
        <tr>
          <th>Action</th>
          <th>Target</th>
          <th>Admin</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="logList"></tbody>
    </table>
    <p id="logEmpty" class="center hidden">Tidak ada logs</p>
  </div>

</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { 
  onAuthStateChanged, 
  signOut 
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

import {
  collection, 
  getDocs, 
  getDoc, 
  doc,
  updateDoc, 
  addDoc, 
  serverTimestamp,
  query,
  orderBy,
  limit
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

/* ===== AVATAR DROPDOWN ===== */
const avatar = document.getElementById("avatar");
const avatarImg = document.getElementById("avatarImg");
const avatarText = document.getElementById("avatarText");
const dropdown = document.getElementById("dropdown");

avatar.onclick = () => {
  dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
};

// Close dropdown when clicking outside
document.addEventListener("click", (e) => {
  if (!e.target.closest(".profile")) {
    dropdown.style.display = "none";
  }
});

/* ===== TABS ===== */
document.querySelectorAll(".tab").forEach(t => {
  t.onclick = () => {
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    document.querySelectorAll(".card").forEach(c => c.classList.add("hidden"));
    t.classList.add("active");
    document.getElementById(t.dataset.tab).classList.remove("hidden");
  };
});

/* ===== AUTH ===== */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "login.html";
    return;
  }

  const userDocRef = doc(db, "users", user.uid);
  const snap = await getDoc(userDocRef);
  
  if (!snap.exists()) {
    alert("‚ùå User data tidak ditemukan");
    location.href = "/";
    return;
  }

  const userData = snap.data();

  // Check admin/owner
  if (!["admin", "owner"].includes(userData.role)) {
    alert("‚ùå Akses ditolak. Hanya admin/owner yang bisa mengakses panel ini.");
    location.href = "/";
    return;
  }

  /* ===== AVATAR SYNC ===== */
  if (userData.photoBase64) {
    avatarImg.src = userData.photoBase64;
    avatarImg.style.display = "block";
    avatarText.style.display = "none";
  } else {
    avatarText.textContent = (userData.name || user.email)[0].toUpperCase();
    avatarImg.style.display = "none";
    avatarText.style.display = "block";
  }

  // Load data
  loadUsers();
  loadVip();
  loadMaintenance();
  loadLogs();
});

/* ===== LOGOUT ===== */
document.getElementById("logoutBtn").onclick = async (e) => {
  e.preventDefault();
  if (confirm("Logout dari admin panel?")) {
    await signOut(auth);
    location.href = "login.html";
  }
};

/* ===== USERS ===== */
const userList = document.getElementById("userList");
const searchUser = document.getElementById("searchUser");
let users = [];

async function loadUsers() {
  try {
    const snap = await getDocs(collection(db, "users"));
    users = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
    renderUsers();
  } catch (err) {
    console.error("Load users error:", err);
    alert("‚ùå Gagal load users: " + err.message);
  }
}

searchUser.oninput = renderUsers;

function renderUsers() {
  userList.innerHTML = "";
  const q = searchUser.value.toLowerCase();
  const filtered = users.filter(u =>
    !q || u.name?.toLowerCase().includes(q) || u.email.toLowerCase().includes(q)
  );

  document.getElementById("userEmpty").classList.toggle("hidden", filtered.length > 0);

  filtered.forEach(u => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="user">
        <img src="${u.photoBase64 || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}">
        <div>
          <strong>${u.name || "-"}</strong>
          <small>${u.email}</small>
        </div>
      </td>
      <td><span class="badge ${u.role}">${u.role.toUpperCase()}</span></td>
      <td><span class="badge ${u.isVIP ? "vip" : "free"}">${u.isVIP ? "VIP" : "FREE"}</span></td>
      <td>
        ${u.role === "member"
          ? `<button class="primary" data-uid="${u.uid}">Toggle VIP</button>`
          : "‚Äî"}
      </td>
    `;
    
    const btn = tr.querySelector("button");
    if (btn) {
      btn.onclick = () => toggleVIP(u);
    }
    
    userList.appendChild(tr);
  });
}

async function toggleVIP(u) {
  if (!confirm(`Ubah status VIP untuk ${u.email}?`)) return;
  
  try {
    await updateDoc(doc(db, "users", u.uid), { isVIP: !u.isVIP });
    await log("TOGGLE_VIP", u.uid);
    alert(`‚úÖ Status VIP ${u.email} berhasil diubah`);
    loadUsers();
  } catch (err) {
    alert("‚ùå Gagal update VIP: " + err.message);
  }
}

/* ===== VIP REQUESTS ===== */
async function loadVip() {
  try {
    const snap = await getDocs(collection(db, "vip_requests"));
    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    const tbody = document.getElementById("vipList");
    
    tbody.innerHTML = "";
    document.getElementById("vipEmpty").classList.toggle("hidden", list.length > 0);

    list.forEach(v => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <strong>${v.name || "-"}</strong><br>
          <small>${v.email}</small>
        </td>
        <td>Rp ${(v.amount || 0).toLocaleString("id-ID")}</td>
        <td><small>${v.transactionId || "-"}</small></td>
        <td><span class="badge ${v.status === "approved" ? "vip" : "free"}">${v.status.toUpperCase()}</span></td>
        <td>
          ${v.status === "pending"
            ? `<button class="success" data-id="${v.id}">‚úÖ Approve</button>`
            : "‚Äî"}
        </td>
      `;
      
      const btn = tr.querySelector("button");
      if (btn) {
        btn.onclick = () => approveVIP(v);
      }
      
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("Load VIP error:", err);
    alert("‚ùå Gagal load VIP requests: " + err.message);
  }
}

async function approveVIP(v) {
  if (!confirm(`Approve VIP request dari ${v.email}?`)) return;
  
  try {
    // Update request status
    await updateDoc(doc(db, "vip_requests", v.id), {
      status: "approved",
      approvedAt: serverTimestamp()
    });
    
    // Set user VIP
    await updateDoc(doc(db, "users", v.uid), { isVIP: true });
    
    // Log activity
    await log("APPROVE_VIP", v.uid);
    
    alert(`‚úÖ VIP request untuk ${v.email} berhasil diapprove!`);
    
    loadVip();
    loadUsers();
  } catch (err) {
    alert("‚ùå Gagal approve VIP: " + err.message);
  }
}

/* ===== MAINTENANCE ===== */
const mtRef = doc(db, "settings", "maintenance");

async function loadMaintenance() {
  try {
    const snap = await getDoc(mtRef);
    const isEnabled = snap.exists() && snap.data().enabled;
    
    document.getElementById("mtStatus").textContent = isEnabled
      ? "üî¥ Maintenance Mode: AKTIF"
      : "üü¢ Maintenance Mode: NONAKTIF";
  } catch (err) {
    console.error("Load maintenance error:", err);
  }
}

document.getElementById("mtOn").onclick = async () => {
  if (!confirm("Aktifkan maintenance mode? Website akan tidak bisa diakses.")) return;
  
  try {
    await updateDoc(mtRef, { enabled: true });
    alert("‚úÖ Maintenance mode diaktifkan");
    loadMaintenance();
  } catch (err) {
    alert("‚ùå Gagal: " + err.message);
  }
};

document.getElementById("mtOff").onclick = async () => {
  try {
    await updateDoc(mtRef, { enabled: false });
    alert("‚úÖ Maintenance mode dinonaktifkan");
    loadMaintenance();
  } catch (err) {
    alert("‚ùå Gagal: " + err.message);
  }
};

/* ===== LOGS ===== */
async function loadLogs() {
  try {
    const q = query(
      collection(db, "admin_logs"),
      orderBy("timestamp", "desc"),
      limit(50)
    );
    
    const snap = await getDocs(q);
    const tbody = document.getElementById("logList");
    
    tbody.innerHTML = "";
    document.getElementById("logEmpty")?.classList.toggle("hidden", snap.docs.length > 0);

    snap.docs.forEach(l => {
      const d = l.data();
      const tr = document.createElement("tr");
      
      const timestamp = d.timestamp?.toDate 
        ? d.timestamp.toDate().toLocaleString("id-ID")
        : "-";
      
      tr.innerHTML = `
        <td><strong>${d.action}</strong></td>
        <td><small>${d.targetUid}</small></td>
        <td><small>${d.adminEmail}</small></td>
        <td><small>${timestamp}</small></td>
      `;
      
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("Load logs error:", err);
  }
}

/* ===== LOG HELPER ===== */
async function log(action, targetUid) {
  try {
    await addDoc(collection(db, "admin_logs"), {
      action,
      targetUid,
      adminUid: auth.currentUser.uid,
      adminEmail: auth.currentUser.email,
      timestamp: serverTimestamp()
    });
  } catch (err) {
    console.error("Log error:", err);
  }
}
</script>

</body>
</html>