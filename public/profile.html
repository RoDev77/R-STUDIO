<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="./images/RSLogo.png">
<link rel="icon" type="image/png" sizes="32x32" href="./images/RSLogo.png">
<link rel="apple-touch-icon" href="./images/RSLogo.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Inter}
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(135deg,#6366f1,#7c3aed);
  display:flex;
  justify-content:center;
  align-items:center;
}

.card{
  background:#fff;
  width:100%;
  max-width:520px;
  padding:32px;
  border-radius:24px;
  box-shadow:0 30px 70px rgba(0,0,0,.25);
}
h1{margin:0 0 20px}
.avatar{
  width:120px;
  height:120px;
  border-radius:50%;
  background:#e5e7eb;
  margin:auto;
  overflow:hidden;
  cursor:pointer;
}
.avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
}
label{
  font-weight:700;
  font-size:13px;
  margin-top:14px;
  display:block;
}
input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:2px solid #e5e7eb;
}
input[readonly]{
  background:#f3f4f6;
}
button{
  margin-top:20px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
  background:linear-gradient(135deg,#facc15,#f59e0b);
}
hr{
  margin:26px 0;
  border:none;
  border-top:1px solid #e5e7eb;
}
.small{font-size:12px;color:#555}

/* ===== NAVBAR ===== */
.navbar{
  height:64px;
  padding:0 32px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:linear-gradient(135deg,#6d7cf2,#7c5cf4);
  color:white;
  position:fixed;
  top:0;
  left:0;
  right:0;
  z-index:99;
}

.brand h2{
  margin:0;
  font-size:20px;
  font-weight:800;
}
.brand span{
  font-size:12px;
  opacity:.85;
}

.profile-nav{
  position:relative;
}

.avatar-nav{
  width:42px;
  height:42px;
  border-radius:50%;
  background:#fff;
  overflow:hidden;
  cursor:pointer;
}

.avatar-nav img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.dropdown{
  position:absolute;
  right:0;
  top:52px;
  width:180px;
  background:white;
  border-radius:14px;
  box-shadow:0 25px 50px rgba(0,0,0,.15);
  overflow:hidden;
  display:none;
}

.dropdown a{
  display:block;
  padding:14px 16px;
  font-size:14px;
  text-decoration:none;
  color:#111827;
}
.dropdown a:hover{
  background:#f3f4f6;
}

/* kasih jarak karena navbar fixed */
body{
  padding-top:90px;
}

/* ===== EMAIL VERIFICATION BOX ===== */
.verification-box{
  background:#fef3c7;
  border:2px solid #fbbf24;
  border-radius:12px;
  padding:16px;
  margin-top:16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.verification-box.verified{
  background:#d1fae5;
  border-color:#10b981;
}

.verification-text{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:14px;
  font-weight:600;
}

.verification-icon{
  font-size:24px;
}

.verify-btn{
  padding:10px 20px;
  background:linear-gradient(135deg,#f59e0b,#d97706);
  color:white;
  border:none;
  border-radius:10px;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
  margin:0;
  width:auto;
}

.verify-btn:hover{
  opacity:0.9;
}

.verify-btn:disabled{
  opacity:0.6;
  cursor:not-allowed;
}

.verified-badge{
  color:#10b981;
  font-weight:700;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:6px;
}

</style>
</head>

<body>
<div class="navbar">
  <div class="brand">
    <h2>R STUDIO</h2>
    <span>Creative dashboard for Roblox developers & creators</span>
  </div>

  <div class="profile-nav">
    <div class="avatar-nav" id="navAvatar">
      <img id="navAvatarImg">
    </div>

    <div class="dropdown" id="dropdown">
      <a href="https://rstudiolab.online/">üöÄ Home</a>
      <a href="license.html">üîê License</a>
      <a href="admin.html" id="adminMenu" style="display:none">üõ† Admin Panel</a>
      <a href="#" id="logoutBtn">üö™ Logout</a>
    </div>
  </div>
</div>

<div class="card">
  <h1>üë§ Profile</h1>

  <!-- FOTO -->
  <input type="file" id="photoInput" accept="image/*" hidden>
  <div class="avatar" id="avatar">
    <img id="avatarImg">
  </div>
  <div class="small" style="text-align:center;margin-top:6px">
    Klik foto untuk mengganti
  </div>

  <!-- INFO -->
  <label>Nama</label>
  <input id="name">

  <label>Email</label>
  <input id="email" readonly>

  <!-- EMAIL VERIFICATION BOX -->
  <div class="verification-box" id="verificationBox">
    <div class="verification-text">
      <span class="verification-icon" id="verificationIcon">‚ö†Ô∏è</span>
      <span id="verificationText">Email belum diverifikasi</span>
    </div>
    <button class="verify-btn" id="verifyBtn">Verifikasi Email</button>
  </div>
  
  <!-- Refresh Status Button (only show if not verified) -->
  <div id="refreshStatusDiv" style="text-align:center;margin-top:8px;display:none">
    <button onclick="location.reload()" style="
      background:transparent;
      color:#6366f1;
      border:2px solid #6366f1;
      padding:8px 16px;
      font-size:12px;
      margin:0;
      width:auto;
    ">
      üîÑ Refresh Status Verifikasi
    </button>
  </div>

  <label>Role</label>
  <input id="role" readonly>

  <button id="saveProfile">üíæ Simpan Profile</button>

  <hr>

  <h3>üîí Ganti Password</h3>

  <label>Password Lama</label>
  <input type="password" id="oldPass">

  <label>Password Baru</label>
  <input type="password" id="newPass">

  <label>Confirm Password Baru</label>
  <input type="password" id="confirmPass">

  <button id="changePass">üîÅ Update Password</button>
</div>

<script type="module">
import { checkMaintenance } from "./firebase.js";
await checkMaintenance();
import { auth, db } from "./firebase.js";
import {
  onAuthStateChanged,
  updateProfile,
  EmailAuthProvider,
  reauthenticateWithCredential,
  updatePassword,
  sendEmailVerification
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

import {
  doc,
  getDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

import { signOut } from
"https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

const avatar = document.getElementById("avatar");
const avatarImg = document.getElementById("avatarImg");
const photoInput = document.getElementById("photoInput");

const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const roleInput = document.getElementById("role");

const oldPassInput = document.getElementById("oldPass");
const newPassInput = document.getElementById("newPass");
const confirmPassInput = document.getElementById("confirmPass");

// Email verification elements
const verificationBox = document.getElementById("verificationBox");
const verificationIcon = document.getElementById("verificationIcon");
const verificationText = document.getElementById("verificationText");
const verifyBtn = document.getElementById("verifyBtn");

let currentUser;

const COOLDOWN = 60;
const KEY = "verify_email_cooldown";

function remaining() {
  const t = localStorage.getItem(KEY);
  if (!t) return 0;
  return Math.max(0, COOLDOWN - Math.floor((Date.now() - t) / 1000));
}

function updateVerifyBtn() {
  const r = remaining();
  if (r > 0) {
    verifyBtn.disabled = true;
    verifyBtn.textContent = `Tunggu ${r}s`;
  } else {
    verifyBtn.disabled = false;
    verifyBtn.textContent = "Verifikasi Email";
  }
}

/* ================= LOAD PROFILE ================= */
const navAvatar = document.getElementById("navAvatar");
const navAvatarImg = document.getElementById("navAvatarImg");
const dropdown = document.getElementById("dropdown");
const adminMenu = document.getElementById("adminMenu");

navAvatar.onclick = ()=>{
  dropdown.style.display =
    dropdown.style.display === "block" ? "none" : "block";
};

/* ================= UPDATE EMAIL VERIFICATION STATUS ================= */
function updateVerificationStatus(isVerified) {
  const refreshDiv = document.getElementById("refreshStatusDiv");
  
  if (isVerified) {
    // Email sudah diverifikasi
    verificationBox.classList.add("verified");
    verificationIcon.textContent = "‚úÖ";
    verificationText.textContent = "Email sudah diverifikasi";
    verifyBtn.style.display = "none";
    if(refreshDiv) refreshDiv.style.display = "none";
  } else {
    // Email belum diverifikasi
    verificationBox.classList.remove("verified");
    verificationIcon.textContent = "‚ö†Ô∏è";
    verificationText.textContent = "Email belum diverifikasi";
    verifyBtn.style.display = "block";
    if(refreshDiv) refreshDiv.style.display = "block";
    
    // Update button cooldown
    setInterval(updateVerifyBtn, 1000);
    updateVerifyBtn();
  }
}

async function loadUserProfile() {
  if(!currentUser) return;

  const snap = await getDoc(doc(db,"users",currentUser.uid));
  if(snap.exists()){
    const data = snap.data();

    roleInput.value = data.role || "member";

    const photo =
      data.photoBase64 ||
      "https://cdn-icons-png.flaticon.com/512/149/149071.png";

    avatarImg.src = photo;
    navAvatarImg.src = photo;

    // ADMIN MENU
    if(data.role === "admin" || data.role === "owner"){
      adminMenu.style.display = "block";
    }

    // Update verification status dari Firestore
    const isVerified = data.emailVerified || false;
    updateVerificationStatus(isVerified);
  } else {
    updateVerificationStatus(false);
  }
}

onAuthStateChanged(auth, async user=>{
  if(!user) return location.href="login.html";
  currentUser = user;

  emailInput.value = user.email;
  nameInput.value = user.displayName || "";

  await loadUserProfile();

  // ‚úÖ CHECK URL PARAMETER (jika dari verifikasi)
  const urlParams = new URLSearchParams(window.location.search);
  if(urlParams.get('verified') === 'true') {
    // Refresh data setelah verifikasi
    setTimeout(async () => {
      await loadUserProfile();
      alert("üéâ Email berhasil diverifikasi!");
      // Clear URL parameter
      window.history.replaceState({}, document.title, "/profile.html");
    }, 500);
  }
});

/* ================= SEND EMAIL VERIFICATION (FIREBASE) ================= */
verifyBtn.onclick = async () => {
  if (remaining() > 0) return;
  
  try {
    verifyBtn.disabled = true;
    verifyBtn.textContent = "Mengirim...";
    
    console.log("üîç Sending verification to:", currentUser.email);
    console.log("üîç User emailVerified status:", currentUser.emailVerified);
    
    // ‚úÖ Gunakan Firebase built-in email verification
    await sendEmailVerification(currentUser, {
      url: window.location.origin + '/action.html',
      handleCodeInApp: false
    });
    
    console.log("‚úÖ Verification email sent successfully!");
    
    localStorage.setItem(KEY, Date.now());
    alert("‚úÖ Email verifikasi telah dikirim menggunakan Firebase!\n\nSilakan cek inbox atau folder spam:\n" + currentUser.email);
    updateVerifyBtn();
    
    // Check verification status setiap 5 detik
    const checkInterval = setInterval(async () => {
      await currentUser.reload();
      if (currentUser.emailVerified) {
        clearInterval(checkInterval);
        
        // Update di Firestore
        await updateDoc(doc(db,"users",currentUser.uid), {
          emailVerified: true,
          verifiedAt: Date.now()
        });
        
        updateVerificationStatus(true);
        alert("üéâ Email Anda telah diverifikasi!");
      }
    }, 5000);
    
  } catch (error) {
    console.error("Error sending verification:", error);
    
    let errorMsg = "‚ùå Gagal mengirim email verifikasi.";
    
    if (error.code === 'auth/too-many-requests') {
      errorMsg = "‚ùå Terlalu banyak percobaan. Tunggu beberapa saat.";
    } else if (error.code === 'auth/invalid-email') {
      errorMsg = "‚ùå Email tidak valid.";
    } else if (error.code === 'auth/user-not-found') {
      errorMsg = "‚ùå User tidak ditemukan.";
    }
    
    alert(errorMsg + "\n\nDetail: " + error.message);
    verifyBtn.disabled = false;
    verifyBtn.textContent = "Verifikasi Email";
  }
};

// LOGOUT
document.getElementById("logoutBtn").onclick = async ()=>{
  await signOut(auth);
  location.href="login.html";
};

/* ================= FOTO PROFILE (BASE64) ================= */
avatar.onclick = ()=> photoInput.click();

photoInput.onchange = ()=>{
  const file = photoInput.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = async ()=>{
    const base64 = reader.result;

    await updateDoc(doc(db,"users",currentUser.uid),{
      photoBase64: base64
    });

    avatarImg.src = base64;
    navAvatarImg.src = base64;
    alert("‚úÖ Foto profile diperbarui");
  };

  reader.readAsDataURL(file);
};

/* ================= SIMPAN NAMA ================= */
document.getElementById("saveProfile").onclick = async ()=>{
  await updateProfile(currentUser,{
    displayName: nameInput.value
  });

  await updateDoc(doc(db,"users",currentUser.uid),{
    name: nameInput.value
  });

  alert("‚úÖ Profile diperbarui");
};

/* ================= GANTI PASSWORD ================= */
document.getElementById("changePass").onclick = async ()=>{
  const oldPass = oldPassInput.value;
  const newPass = newPassInput.value;
  const confirm = confirmPassInput.value;

  if(!oldPass || !newPass || !confirm) {
    return alert("‚ùå Semua field password harus diisi");
  }

  if(newPass !== confirm) {
    return alert("‚ùå Password baru tidak cocok");
  }

  if(newPass.length < 6) {
    return alert("‚ùå Password minimal 6 karakter");
  }

  try {
    const cred = EmailAuthProvider.credential(
      currentUser.email,
      oldPass
    );

    await reauthenticateWithCredential(currentUser,cred);
    await updatePassword(currentUser,newPass);

    // Clear inputs
    oldPassInput.value = "";
    newPassInput.value = "";
    confirmPassInput.value = "";

    alert("üîê Password berhasil diubah");
  } catch (error) {
    console.error("Error changing password:", error);
    if (error.code === "auth/wrong-password") {
      alert("‚ùå Password lama salah");
    } else {
      alert("‚ùå Gagal mengubah password: " + error.message);
    }
  }
};
</script>



</body>
</html>