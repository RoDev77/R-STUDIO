<!-- profile.html -->
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="./images/RSLogo.png">
<link rel="icon" type="image/png" sizes="32x32" href="./images/RSLogo.png">
<link rel="apple-touch-icon" href="./images/RSLogo.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Inter}
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(135deg,#6366f1,#7c3aed);
  display:flex;
  justify-content:center;
  align-items:center;
}

.card{
  background:#fff;
  width:100%;
  max-width:520px;
  padding:32px;
  border-radius:24px;
  box-shadow:0 30px 70px rgba(0,0,0,.25);
}
h1{margin:0 0 20px}
.avatar{
  width:120px;
  height:120px;
  border-radius:50%;
  background:#e5e7eb;
  margin:auto;
  overflow:hidden;
  cursor:pointer;
}
.avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
}
label{
  font-weight:700;
  font-size:13px;
  margin-top:14px;
  display:block;
}
input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:2px solid #e5e7eb;
}
input[readonly]{
  background:#f3f4f6;
}
button{
  margin-top:20px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
  background:linear-gradient(135deg,#facc15,#f59e0b);
}
hr{
  margin:26px 0;
  border:none;
  border-top:1px solid #e5e7eb;
}
.small{font-size:12px;color:#555}

/* ===== NAVBAR ===== */
.navbar{
  height:64px;
  padding:0 32px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:linear-gradient(135deg,#6d7cf2,#7c5cf4);
  color:white;
  position:fixed;
  top:0;
  left:0;
  right:0;
  z-index:99;
}

.brand h2{
  margin:0;
  font-size:20px;
  font-weight:800;
}
.brand span{
  font-size:12px;
  opacity:.85;
}

.profile-nav{
  position:relative;
}

.avatar-nav{
  width:42px;
  height:42px;
  border-radius:50%;
  background:#fff;
  overflow:hidden;
  cursor:pointer;
}

.avatar-nav img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.dropdown{
  position:absolute;
  right:0;
  top:52px;
  width:180px;
  background:white;
  border-radius:14px;
  box-shadow:0 25px 50px rgba(0,0,0,.15);
  overflow:hidden;
  display:none;
}

.dropdown a{
  display:block;
  padding:14px 16px;
  font-size:14px;
  text-decoration:none;
  color:#111827;
}
.dropdown a:hover{
  background:#f3f4f6;
}

/* kasih jarak karena navbar fixed */
body{
  padding-top:90px;
}

/* ===== EMAIL VERIFICATION BOX ===== */
.verification-box{
  background:#fef3c7;
  border:2px solid #fbbf24;
  border-radius:12px;
  padding:16px;
  margin-top:16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.verification-box.verified{
  background:#d1fae5;
  border-color:#10b981;
}

.verification-text{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:14px;
  font-weight:600;
}

.verification-icon{
  font-size:24px;
}

.verify-btn{
  padding:10px 20px;
  background:linear-gradient(135deg,#f59e0b,#d97706);
  color:white;
  border:none;
  border-radius:10px;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
  margin:0;
  width:auto;
}

.verify-btn:hover{
  opacity:0.9;
}

.verified-badge{
  color:#10b981;
  font-weight:700;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:6px;
}

</style>
</head>

<body>
<div class="navbar">
  <div class="brand">
    <h2>R STUDIO</h2>
    <span>Creative Dashboard</span>
  </div>

  <div class="profile-nav">
    <div class="avatar-nav" id="navAvatar">
      <img id="navAvatarImg">
    </div>

    <div class="dropdown" id="dropdown">
      <a href="https://rstudiolab.online/">üöÄ Home</a>
      <a href="license.html">üîê License</a>
      <a href="admin.html" id="adminMenu" style="display:none">üõ† Admin Panel</a>
      <a href="#" id="logoutBtn">üö™ Logout</a>
    </div>
  </div>
</div>

<div class="card">
  <h1>üë§ Profile</h1>

  <!-- FOTO -->
  <input type="file" id="photoInput" accept="image/*" hidden>
  <div class="avatar" id="avatar">
    <img id="avatarImg">
  </div>
  <div class="small" style="text-align:center;margin-top:6px">
    Klik foto untuk mengganti
  </div>

  <!-- INFO -->
  <label>Nama</label>
  <input id="name">

  <label>Email</label>
  <input id="email" readonly>

  <!-- EMAIL VERIFICATION BOX -->
  <div class="verification-box" id="verificationBox">
    <div class="verification-text">
      <span class="verification-icon" id="verificationIcon">‚ö†Ô∏è</span>
      <span id="verificationText">Email belum diverifikasi</span>
    </div>
    <button class="verify-btn" id="verifyBtn">Verifikasi Email</button>
  </div>

  <label>Role</label>
  <input id="role" readonly>

  <button id="saveProfile">üíæ Simpan Profile</button>

  <hr>

  <h3>üîí Ganti Password</h3>

  <label>Password Lama</label>
  <input type="password" id="oldPass">

  <label>Password Baru</label>
  <input type="password" id="newPass">

  <label>Confirm Password Baru</label>
  <input type="password" id="confirmPass">

  <button id="changePass">üîÅ Update Password</button>
</div>

<script type="module">
import { checkMaintenance } from "./firebase.js";
await checkMaintenance();

import { auth, db } from "./firebase.js";
import {
  onAuthStateChanged,
  updateProfile,
  EmailAuthProvider,
  reauthenticateWithCredential,
  updatePassword,
  sendEmailVerification,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

import {
  doc,
  getDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

/* ================= DOM ================= */
const avatarImg = document.getElementById("avatarImg");
const navAvatarImg = document.getElementById("navAvatarImg");
const nameInput = document.getElementById("name");
const emailInput = document.getElementById("email");
const roleInput = document.getElementById("role");
const adminMenu = document.getElementById("adminMenu");

const verificationBox = document.getElementById("verificationBox");
const verificationIcon = document.getElementById("verificationIcon");
const verificationText = document.getElementById("verificationText");
const verifyBtn = document.getElementById("verifyBtn");

let currentUser;

/* ================= UI ================= */
function updateVerificationStatus(isVerified) {
  if (isVerified) {
    verificationBox.classList.add("verified");
    verificationIcon.textContent = "‚úÖ";
    verificationText.textContent = "Email sudah diverifikasi";
    verifyBtn.style.display = "none";
  } else {
    verificationBox.classList.remove("verified");
    verificationIcon.textContent = "‚ö†Ô∏è";
    verificationText.textContent = "Email belum diverifikasi";
    verifyBtn.style.display = "block";
  }
}

/* ================= AUTH ================= */
onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";
  currentUser = user;

  emailInput.value = user.email;
  nameInput.value = user.displayName || "";

  const snap = await getDoc(doc(db, "users", user.uid));
  const data = snap.exists() ? snap.data() : {};

  roleInput.value = data.role || "member";

  if (data.role === "admin" || data.role === "owner") {
    adminMenu.style.display = "block";
  }

  const photo =
    data.photoBase64 ||
    "https://cdn-icons-png.flaticon.com/512/149/149071.png";

  avatarImg.src = photo;
  navAvatarImg.src = photo;

  // üîë SOURCE OF TRUTH = FIREBASE AUTH
  const isVerified = user.emailVerified;

  await updateDoc(doc(db, "users", user.uid), {
    emailVerified: isVerified
  });

  updateVerificationStatus(isVerified);
});

/* ================= EMAIL VERIFY ================= */
verifyBtn.onclick = async () => {
  try {
    verifyBtn.disabled = true;
    verifyBtn.textContent = "Mengirim...";

    await sendEmailVerification(currentUser);

    alert("‚úÖ Email verifikasi dikirim. Silakan cek inbox / spam.");
    verifyBtn.textContent = "Email terkirim";
  } catch (err) {
    alert("‚ùå Gagal kirim email: " + err.message);
    verifyBtn.disabled = false;
    verifyBtn.textContent = "Verifikasi Email";
  }
};

/* ================= SAVE PROFILE ================= */
document.getElementById("saveProfile").onclick = async () => {
  await updateProfile(currentUser, {
    displayName: nameInput.value
  });

  await updateDoc(doc(db, "users", currentUser.uid), {
    name: nameInput.value
  });

  alert("‚úÖ Profile diperbarui");
};

/* ================= CHANGE PASSWORD ================= */
document.getElementById("changePass").onclick = async () => {
  const oldPass = oldPassInput.value;
  const newPass = newPassInput.value;
  const confirm = confirmPassInput.value;

  if (newPass !== confirm)
    return alert("Password tidak cocok");

  const cred = EmailAuthProvider.credential(
    currentUser.email,
    oldPass
  );

  await reauthenticateWithCredential(currentUser, cred);
  await updatePassword(currentUser, newPass);

  alert("üîê Password berhasil diubah");
};

/* ================= LOGOUT ================= */
document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
  location.href = "login.html";
};
</script>



</body>
</html>